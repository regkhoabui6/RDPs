name: üöÄ AI STV ‚Äì VIRGIN RDP

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: true
        default: '3h'
        type: choice
        options:
          - '1h'
          - '3h'
          - '5h40m'

jobs:
  virgin-rdp:
    runs-on: windows-latest
    timeout-minutes: 340

    steps:
    # =========================
    # BANNER
    # =========================
    - name: üéØ KH·ªûI ƒê·ªòNG
      run: |
        Write-Host ""
        Write-Host "üöÄ AI STV ‚Äì VIRGIN RDP" -ForegroundColor Cyan
        Write-Host "üßº User tr·∫Øng ‚Äì kh√¥ng app ‚Äì kh√¥ng setup" -ForegroundColor Green
        Write-Host "‚è∞ Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Yellow
        Write-Host ""

    # =========================
    # B·∫¨T RDP T·ªêI THI·ªÇU
    # =========================
    - name: üîß B·∫¨T RDP C∆† B·∫¢N
      run: |
        Set-ItemProperty `
          'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name fDenyTSConnections -Value 0 -Force

        netsh advfirewall firewall add rule `
          name="RDP" dir=in action=allow protocol=TCP localport=3389

        Start-Service TermService
        Write-Host "‚úÖ RDP ƒë√£ b·∫≠t" -ForegroundColor Green

    # =========================
    # T·∫†O USER VIRGIN
    # =========================
    - name: üë§ T·∫†O USER TR·∫ÆNG
      run: |
        function New-RandomPassword {
          $chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789"
          -join (1..10 | ForEach-Object { $chars | Get-Random -Count 1 })
        }

        $USER = "VIRGIN-$($env:GITHUB_RUN_ID)"
        $PASS = New-RandomPassword

        $secure = ConvertTo-SecureString $PASS -AsPlainText -Force

        Remove-LocalUser -Name $USER -ErrorAction SilentlyContinue

        New-LocalUser `
          -Name $USER `
          -Password $secure `
          -AccountNeverExpires `
          -Description "Virgin RDP User"

        Add-LocalGroupMember "Remote Desktop Users" $USER

        echo "RDP_USER=$USER" >> $env:GITHUB_ENV
        echo "RDP_PASS=$PASS" >> $env:GITHUB_ENV

        Write-Host "‚úÖ User VIRGIN t·∫°o xong" -ForegroundColor Green

    # =========================
    # HI·ªÇN TH·ªä TH√îNG TIN
    # =========================
    - name: üéâ TH√îNG TIN ƒêƒÇNG NH·∫¨P
      run: |
        $duration = "${{ github.event.inputs.duration }}"
        switch ($duration) {
          "1h" { $m = 60 }
          "3h" { $m = 180 }
          "5h40m" { $m = 340 }
        }

        $start = Get-Date
        $end = $start.AddMinutes($m)

        Write-Host ""
        Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
        Write-Host "‚îÇ üîë USER: $env:RDP_USER" -ForegroundColor White
        Write-Host "‚îÇ üîê PASS: $env:RDP_PASS" -ForegroundColor White
        Write-Host "‚îÇ üåê IP  : d√πng IP runner" -ForegroundColor White
        Write-Host "‚îÇ ‚è∞ END : $($end.ToString("HH:mm:ss"))" -ForegroundColor White
        Write-Host "‚îÇ üßº USER CH∆ØA LOGIN ‚Üí TR·∫ÆNG" -ForegroundColor Green
        Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan

        echo "END_TIME=$($end.ToString("o"))" >> $env:GITHUB_ENV

    # =========================
    # GI·ªÆ PHI√äN
    # =========================
    - name: ‚è≥ GI·ªÆ PHI√äN
      run: |
        $end = [DateTime]::Parse($env:END_TIME)

        while ((Get-Date) -lt $end) {
          $left = $end - (Get-Date)
          Write-Host "`r‚è≥ C√≤n $([int]$left.TotalMinutes) ph√∫t" -NoNewline
          Start-Sleep 30
        }

        Write-Host ""
        Write-Host "‚õî H·∫æT GI·ªú" -ForegroundColor Red

    # =========================
    # D·ªåN D·∫∏P
    # =========================
    - name: üßπ D·ªåN D·∫∏P
      if: always()
      run: |
        Remove-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue
        netsh advfirewall firewall delete rule name="RDP" dir=in
        Stop-Service TermService -Force
        Write-Host "üßº ƒê√£ x√≥a user ‚Äì k·∫øt th√∫c" -ForegroundColor Yellow
